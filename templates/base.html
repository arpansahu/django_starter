<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

  <title>
      {% block title %}{% endblock %}
  </title>

  <!--     Fonts and icons     -->
  <link href="{% static 'fonts/open-sans/open-sans.css' %}" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{% static 'assets/css/nucleo-icons.css' %}" rel="stylesheet" />
  <link href="{% static 'assets/css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- Font Awesome Icons (Local) -->
  <link rel="stylesheet" href="{% static 'fontawesome/css/all.min.css' %}" />
  <link href="{% static 'assets/css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'assets/css/soft-ui-dashboard.css' %}" rel="stylesheet" />
  <script src="{% static 'libs/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <!-- Jquery/AJAX -->
  <script src="{% static 'js/jquery.js' %}"></script>
  
  <!-- Sentry SDK for JavaScript -->
  <script src="https://js.sentry-cdn.com/41f62eed6cda9d796986c9379d0355f1.min.js" crossorigin="anonymous"></script>

  <!-- Specific CSS goes HERE -->
    <link rel="stylesheet" href="{% static 'libs/autocomplete/autocomplete.css' %}"/>
    <link rel="stylesheet" href="{% static 'libs/flatpickr/flatpickr.min.css' %}"/>
  {% block stylesheets %}
    <style>
      html {
        {#font-size: 14px;#}
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Full viewport height */
      }
      .main-content {
          flex-grow: 1; /* Expands to take available space, pushing footer down */
      } 
      footer {
          margin-top: auto; /* Push footer to bottom */
          height: 80px; /* Fixed footer height */
      }
    </style>
  {% endblock stylesheets %}
</head>
<body class="d-flex flex-column min-vh-100 g-sidenav-show bg-gray-100">
  <!-- Main content with flex-grow to take available space -->
  <main class="main-content flex-grow-1 position-relative border-radius-lg">
      {% include 'snippets/header.html' %}
      {% block content %}{% endblock %}
  </main>

  <!-- Footer at the bottom -->
  <footer class="container-fluid py-2">
      {% include 'snippets/footer.html' %}
  </footer>

  {% include "snippets/scripts.html" %}
  <script src="{% static 'js/jquery.js' %}"></script>

  <!-- Toast Notification Styles -->
  <style>
    #toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 380px;
    }
    .toast-notification {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border-left: 4px solid #667eea;
      animation: toastSlideIn 0.35s ease-out;
      font-size: 0.85rem;
      color: #2d3748;
      max-width: 100%;
      word-wrap: break-word;
    }
    .toast-notification.toast-success { border-left-color: #38a169; }
    .toast-notification.toast-error   { border-left-color: #e53e3e; }
    .toast-notification.toast-warning { border-left-color: #dd6b20; }
    .toast-notification.toast-info    { border-left-color: #667eea; }
    .toast-notification .toast-icon {
      font-size: 1rem;
      margin-top: 2px;
      flex-shrink: 0;
    }
    .toast-notification.toast-success .toast-icon { color: #38a169; }
    .toast-notification.toast-error .toast-icon   { color: #e53e3e; }
    .toast-notification.toast-warning .toast-icon { color: #dd6b20; }
    .toast-notification.toast-info .toast-icon    { color: #667eea; }
    .toast-notification .toast-body { flex: 1; }
    .toast-notification .toast-title {
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    .toast-notification .toast-message {
      font-size: 0.78rem;
      color: #718096;
      line-height: 1.4;
    }
    .toast-notification .toast-close {
      background: none;
      border: none;
      color: #a0aec0;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 0;
      flex-shrink: 0;
    }
    .toast-notification .toast-close:hover { color: #2d3748; }
    .toast-fade-out {
      animation: toastFadeOut 0.3s ease-in forwards;
    }
    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    @keyframes toastFadeOut {
      from { opacity: 1; transform: translateX(0); }
      to   { opacity: 0; transform: translateX(100%); }
    }
    /* Notification dropdown item */
    .notif-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 10px 14px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.8rem;
      color: #4a5568;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item .notif-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-top: 5px;
      flex-shrink: 0;
    }
    .notif-item .notif-dot.success { background: #38a169; }
    .notif-item .notif-dot.error   { background: #e53e3e; }
    .notif-item .notif-dot.warning { background: #dd6b20; }
    .notif-item .notif-dot.info    { background: #667eea; }
    .notif-item .notif-text { flex: 1; }
    .notif-item .notif-title { font-weight: 600; font-size: 0.78rem; color: #2d3748; }
    .notif-item .notif-msg { font-size: 0.72rem; color: #718096; margin-top: 1px; }
    .notif-item .notif-time { font-size: 0.65rem; color: #cbd5e0; margin-top: 2px; }
  </style>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <script>
  (function() {
    // ==================== Toast System ====================
    const TOAST_ICONS = {
      success: 'fa-solid fa-circle-check',
      error:   'fa-solid fa-circle-xmark',
      warning: 'fa-solid fa-triangle-exclamation',
      info:    'fa-solid fa-circle-info',
    };

    function showToast(title, message, level, duration) {
      level = level || 'info';
      duration = duration || 5000;
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast-notification toast-' + level;
      toast.innerHTML =
        '<i class="toast-icon ' + (TOAST_ICONS[level] || TOAST_ICONS.info) + '"></i>' +
        '<div class="toast-body">' +
          (title ? '<div class="toast-title">' + title + '</div>' : '') +
          '<div class="toast-message">' + message + '</div>' +
        '</div>' +
        '<button class="toast-close" onclick="this.parentElement.remove()"><i class="fa-solid fa-xmark"></i></button>';
      container.appendChild(toast);
      setTimeout(function() {
        toast.classList.add('toast-fade-out');
        setTimeout(function() { toast.remove(); }, 300);
      }, duration);
    }

    window.showToast = showToast;

    // ==================== Notification Bell ====================
    let notifCount = 0;
    const notifications = [];

    function updateBadge() {
      const badge = document.getElementById('notif-badge');
      if (!badge) return;
      if (notifCount > 0) {
        badge.textContent = notifCount > 9 ? '9+' : notifCount;
        badge.style.display = '';
      } else {
        badge.style.display = 'none';
      }
    }

    function addNotifToDropdown(title, message, level, timestamp) {
      const list = document.getElementById('notif-list');
      const empty = document.getElementById('notif-empty');
      if (empty) empty.style.display = 'none';

      const item = document.createElement('div');
      item.className = 'notif-item';
      const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'now';
      item.innerHTML =
        '<div class="notif-dot ' + (level || 'info') + '"></div>' +
        '<div class="notif-text">' +
          '<div class="notif-title">' + (title || 'Notification') + '</div>' +
          '<div class="notif-msg">' + (message || '') + '</div>' +
          '<div class="notif-time">' + timeStr + '</div>' +
        '</div>';
      list.insertBefore(item, list.firstChild === empty ? null : list.firstChild);
      notifications.unshift({title, message, level, timestamp});
    }

    // Toggle dropdown
    const bell = document.getElementById('notif-bell');
    const dropdown = document.getElementById('notif-dropdown');
    if (bell && dropdown) {
      bell.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = dropdown.style.display !== 'none';
        dropdown.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
          notifCount = 0;
          updateBadge();
        }
      });
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && e.target !== bell) {
          dropdown.style.display = 'none';
        }
      });
    }

    // Clear all
    const clearBtn = document.getElementById('notif-clear-all');
    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        const list = document.getElementById('notif-list');
        list.innerHTML = '<div id="notif-empty" class="text-center py-4" style="color:#a0aec0;font-size:0.8rem;"><i class="fa-regular fa-bell-slash" style="font-size:1.5rem;display:block;margin-bottom:0.5rem;"></i>No notifications</div>';
        notifCount = 0;
        notifications.length = 0;
        updateBadge();
      });
    }

    // ==================== WebSocket Connection ====================
    {% if request.user.is_authenticated %}
    (function connectWS() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = wsProtocol + window.location.host + '/ws/notifications/';
      let ws = null;
      let reconnectDelay = 1000;

      function connect() {
        ws = new WebSocket(wsUrl);
        ws.onopen = function() {
          console.log('[Notifications] WebSocket connected');
          reconnectDelay = 1000;
        };
        ws.onmessage = function(e) {
          try {
            const data = JSON.parse(e.data);
            showToast(data.title, data.message, data.level, 6000);
            addNotifToDropdown(data.title, data.message, data.level, data.timestamp);
            notifCount++;
            updateBadge();
            // Subtle bell shake
            if (bell) {
              bell.style.animation = 'none';
              void bell.offsetWidth;
              bell.style.animation = 'bellShake 0.5s ease';
            }
          } catch (err) { console.error('[Notifications] Parse error:', err); }
        };
        ws.onclose = function(e) {
          console.log('[Notifications] WebSocket closed, reconnecting in', reconnectDelay, 'ms');
          setTimeout(connect, reconnectDelay);
          reconnectDelay = Math.min(reconnectDelay * 2, 30000);
        };
        ws.onerror = function(err) {
          console.error('[Notifications] WebSocket error:', err);
          ws.close();
        };
      }
      connect();
    })();
    {% endif %}

    // ==================== Django Messages â†’ Toasts ====================
    {% if messages %}
      {% for message in messages %}
        showToast(
          '',
          '{{ message|escapejs }}',
          '{{ message.tags|escapejs }}'.replace('debug', 'info'),
          5000
        );
        addNotifToDropdown('', '{{ message|escapejs }}', '{{ message.tags|escapejs }}'.replace('debug', 'info'), new Date().toISOString());
        notifCount++;
      {% endfor %}
      updateBadge();
    {% endif %}
  })();
  </script>

  <style>
    @keyframes bellShake {
      0%   { transform: rotate(0); }
      15%  { transform: rotate(15deg); }
      30%  { transform: rotate(-10deg); }
      45%  { transform: rotate(8deg); }
      60%  { transform: rotate(-5deg); }
      75%  { transform: rotate(3deg); }
      100% { transform: rotate(0); }
    }
  </style>

  {% block javascripts %}{% endblock %}
</body>
</html>
