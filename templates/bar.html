{% extends 'base.html' %}
{% load static %}
{% block title %} Django Starter {% endblock title %}
{% load custom_tags %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
    #progress-bar-container {
        width: 100%;
        background-color: #e0e0e0;
        height: 30px;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 20px;
    }

    #progress-bar {
        width: 0;
        height: 100%;
        background: linear-gradient(90deg, rgba(36,198,220,1) 0%, rgba(0,148,255,1) 100%);
        transition: width 0.4s ease;
    }

    #start-task {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #start-task:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    #progress-bar-message {
        margin-top: 10px;
        font-weight: bold;
        color: #333;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid py-4">
    <h1>Task Progress</h1>
    <button id="start-task">Start Task</button>
    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>
    <p id="progress-bar-message">Waiting for task...</p>
</div>
{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script src="{% static 'celery_progress/celery_progress.js' %}"></script>
<script src="{% static 'celery_progress/celery_websocket.js' %}"></script>
<script>
    const startTaskButton = document.getElementById('start-task');
    const progressBar = document.getElementById('progress-bar');
    const progressBarMessage = document.getElementById('progress-bar-message');

    startTaskButton.addEventListener('click', () => {
        // Disable the button while the task is in progress
        startTaskButton.disabled = true;
        progressBarMessage.textContent = "Task started...";

        fetch('/start-task/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const task_id = data.task_id;
            const wsBar = new CeleryWebSocketProgressBar(`/ws/progress/${task_id}/`, {
                onProgress(progressBarElement, progressBarMessageElement, progress) {
                    progressBarElement.style.width = progress.percent + '%';
                    progressBarMessageElement.textContent = progress.current + ' of ' + progress.total + ' processed.';
                },
                onSuccess(progressBarElement, progressBarMessageElement) {
                    progressBarElement.style.backgroundColor = '#28a745';  // Change bar color to green on success
                    progressBarMessageElement.textContent = "Task completed successfully!";
                    startTaskButton.disabled = false;  // Re-enable the button
                },
                onError(progressBarElement, progressBarMessageElement, error) {
                    progressBarElement.style.backgroundColor = '#dc3545';  // Red on error
                    progressBarMessageElement.textContent = "Error: " + error;
                    startTaskButton.disabled = false;  // Re-enable the button
                }
            });
            wsBar.connect();
        });
    });
</script>
{% endblock javascripts %}
